<script type="module">
  import {onCLS, onINP, onLCP, onFCP, onTTFB} from '/assets/web-vitals.js';

  function waitForGoatCounter(callback, attempts) {
    attempts = attempts || 0;
    if (window.goatcounter && typeof window.goatcounter.count === 'function') {
      callback();
      return;
    }
    if (attempts < 50) {
      setTimeout(function() { waitForGoatCounter(callback, attempts + 1); }, 100);
    }
  }

  var pending = [];

  function sendToGoatCounter(metric) {
    pending.push(metric);
  }

  function flushMetrics() {
    waitForGoatCounter(function() {
      pending.forEach(function(metric) {
        window.goatcounter.count({
          path: 'web-vitals/' + metric.name,
          title: metric.name + ': ' + Math.round(metric.value),
          event: true
        });
      });
      pending = [];
    });
  }

  onCLS(sendToGoatCounter);
  onINP(sendToGoatCounter);
  onLCP(sendToGoatCounter);
  onFCP(sendToGoatCounter);
  onTTFB(sendToGoatCounter);

  document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'hidden') flushMetrics();
  });
  window.addEventListener('pagehide', flushMetrics);
  setTimeout(flushMetrics, 5000);
</script>
